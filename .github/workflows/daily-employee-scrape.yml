name: Daily employee scrape

on:
  schedule:
    - cron: "0 23 * * *"
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Wake Render service
        run: |
          echo "Waking Render service..."
          curl -v --max-time 180 https://ppm-scripts-fs.onrender.com/

      - name: Wait 1 minute for warm-up
        run: |
          echo "Waiting 60 seconds..."
          sleep 60

      - name: Trigger scrape (up to 3 retries)
        run: |
          echo "Triggering scrape with retries..."
          for i in 1 2 3; do
            echo "Attempt $i..."
            if curl -f --max-time 30 \
              -H "X-CRON-SECRET: ${{ secrets.CRON_SECRET }}" \
              -X POST https://ppm-scripts-fs.onrender.com/api/v1/employees; then
              echo "Scrape triggered successfully"
              exit 0
            fi

            echo "Attempt $i failed, waiting 60 seconds before retry..."
            sleep 60
          done

          echo "All attempts failed"
          exit 1
